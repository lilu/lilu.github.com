
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Why coffee script is awesome - lilu.life</title>
  <meta name="author" content="lilu">

  
  <meta name="description" content="序 Every language feature in CoffeeScript has been designed using this kind of process: attempt to take the beautiful dynamic semantics of JavaScript— &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://lilu.github.com/blog/2012/08/06/coffeescript">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/bootstrap/bootstrap.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/bootstrap/responsive.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/syntax/syntax.css" media="screen, projection" rel="stylesheet" type="text/css">
  <style type="text/css">
    body {
      padding-bottom: 40px;
    }
    h1 {
      margin-bottom: 15px;
    }
    img {
      max-width: 100%;
    }
    .sharing, .meta, .pager {
      margin: 20px 0px 20px 0px;
    }
    .page-footer p {
      text-align: center;
    }
  </style>
  <script src="/javascripts/libs/jquery.js"></script>
  <script src="/javascripts/libs/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/bootstrap.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="lilu.life" type="application/atom+xml">
  
  

</head>

<body   >
  <nav role="navigation"><div class="navbar">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <a class="brand" href="/">lilu.life</a>

      <div class="nav-collapse">
        <ul class="nav">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/recommends">Recommends</a></li>
</ul>


        <ul class="nav pull-right" data-subscription="rss">
          <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
          
        </ul>

        
          <form class="pull-right navbar-search" action="http://google.com/search" method="get">
            <fieldset role="search">
              <input type="hidden" name="q" value="site:lilu.github.com" />
              <input class="search-query" type="text" name="q" results="0" placeholder="Search"/>
            </fieldset>
          </form>
        
      </div>
    </div>
  </div>
</div>
</nav>
  <div class="container">
    <div class="row-fluid">
      
<article class="hentry span9" role="article">

  
  <header class="page-header">
    
      <h1 class="entry-title">Why Coffee Script Is Awesome</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-06T12:52:00+08:00" pubdate data-updated="true">2012-08-06 12:52:00</time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>序</h2>

<hr />

<blockquote><p>Every language feature in CoffeeScript has been designed using this kind of process:
  attempt to take the beautiful dynamic semantics of JavaScript—object literals, function expressions, prototypal inheritance—and express them in a clean, readable, minimal way.
<small>by Jeremy Ashkenas, author of CoffeeScript</small></p></blockquote>

<p><a href="http://coffeescript.org/">CoffeeScript</a>是一门简洁的，构架于JavaScript之上的预处理器语言，可以静态编译成JavaScript，语法主要受ruby和python影响，目前已经为众多rails和node项目采用。</p>

<p>为什么要用CoffeeScript?</p>

<ul>
<li>更少，更紧凑，和更清晰的代码</li>
<li>通过规避和改变对JavaScript中不良部分的使用，只留下精华，让代码减少出错率，更容易维护</li>
<li>在很多常用模式的实现上采用了JavaScript中的最佳实践</li>
<li>CoffeeScript生成的JavaScript代码都可以完全通过<a href="http://www.javascriptlint.com/">JSLint</a>的检测</li>
</ul>


<p>什么情况下不推荐使用CoffeeScript?</p>

<ul>
<li>CoffeeScript不是JavaScript的超集，也不是完全替代品，不应该在不会JavaScript的情况下使用CoffeeScript工作</li>
</ul>


<p>CoffeeScript是一种需要预编译的语言，不能在运行时(Runtime)解释，这造成了她普遍被人质疑的一点，就是如果代码中出现运行时错误时难以调试，不过从实际使用上来看，因为CoffeeScript的编译结果大部分情况下自然而合理，至少我从来没有发现从生成的JavaScript代码回溯到对应的CoffeeScript代码有什么困难之处，我们稍后会看到这种对应关系的细节</p>

<p>这种静态编译还有一个额外的好处，就是CoffeeScript和现有的环境(浏览器,Node,Rhino等)与库完全兼容</p>

<p>最简单的安装和测试CoffeeScript的方法，是使用<em>node.js</em>的<em>npm</em>安装，然后使用命令行脚本实时编译</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>npm install -g coffee-script
</span><span class='line'><span class="c"># watch and compile</span>
</span><span class='line'>coffee -w --output lib --compile src
</span></code></pre></td></tr></table></div></figure>


<p>这里假设你的coffee代码在src目录下，这个daemon会自动检测文件的改变，并编译成js文件放到lib目录下</p>

<hr />

<h2>语法</h2>

<p>与SASS/LESS和CSS的关系不同，CoffeeScript不是JavaScript的超集，不能在CoffeeScript程序中写JavaScript代码，比如<code>function</code>等关键字</p>

<h3>格式</h3>

<p>在js中，如果认为当前语句和随后语句是一个整体的话，就不会自己加<code>;</code>，比如以下javascript代码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//javascript code</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">x</span><span class="o">+</span><span class="nx">f</span>
</span><span class='line'><span class="p">(</span><span class="nx">a</span><span class="o">+</span><span class="nx">b</span><span class="p">).</span><span class="nx">toString</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//parsed to:</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">x</span><span class="o">+</span><span class="nx">f</span><span class="p">(</span><span class="nx">a</span><span class="o">+</span><span class="nx">b</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>很多js中的问题由此引起(实际上现在把<code>;</code>放在哪里，在js社区内也是个争论的话题)</p>

<p>而CoffeeScript在编译时为每条语句加上<code>;</code>，因此在代码中<strong>不需要</strong>写<code>;</code></p>

<p>CoffeeScript中的注释采用<code>#</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="c1"># single line comment</span>
</span><span class='line'><span class="cm">### </span>
</span><span class='line'><span class="cm">  multi line comment</span>
</span><span class='line'><span class="cm">###</span>
</span></code></pre></td></tr></table></div></figure>


<p>CoffeeScript中对空白敏感，这种做法来自python，任何需要<code>({})</code>的场合下，可以用缩进代替</p>

<h3>作用域</h3>

<p>在js中最糟糕的设计就是全局变量，当你忘记用<code>var</code>声明变量的时候，这个变量会成为全局对象上的一个属性</p>

<p>CoffeeScript避免了这点</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">foo = </span><span class="s">&quot;bar&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>会编译成</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">foo</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">foo</span> <span class="o">=</span> <span class="s2">&quot;bar&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>任何的代码都会使用<em>Immediate Function</em>包装，这样<code>foo</code>成为了本地变量，并且，可以通过<code>call</code>指定的<code>this</code>引用全局对象</p>

<p>为了方便起见，之后的编译后代码描述不会再加上这个包装</p>

<p>实际上在CoffeeScript中，你也不需要再用<code>var</code>声明变量，编译后会自动加上<code>var</code>，并且将声明<em>hoisting</em>，即放到作用域的顶部，看一个来自官方文档的例子</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">outer = </span><span class="mi">1</span>
</span><span class='line'><span class="nv">change = </span><span class="o">-&gt;</span>
</span><span class='line'>  <span class="nv">inner = </span><span class="o">-</span><span class="mi">1</span>
</span><span class='line'>  <span class="nv">outer = </span><span class="mi">10</span>
</span><span class='line'><span class="nv">inner = </span><span class="nx">change</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>-&gt;</code>是函数定义的简写方式，之后我们会探讨</p>

<p>编译后的js如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kd">var</span> <span class="nx">change</span><span class="p">,</span> <span class="nx">inner</span><span class="p">,</span> <span class="nx">outer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">outer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">change</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">inner</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">inner</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">outer</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">inner</span> <span class="o">=</span> <span class="nx">change</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是类似ruby中的自然的作用域实现方式，<code>inner</code>在<code>change()</code>内定义成了局部变量，因为在代码中之前没有定义过</p>

<h3>赋值</h3>

<p>首先是字符串可以用类ruby的语法内嵌</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">target = </span><span class="s">&quot;world&quot;</span>
</span><span class='line'><span class="nx">alert</span> <span class="s">&quot;hello, </span><span class="si">#{</span><span class="nx">target</span><span class="si">}</span><span class="s">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>其次是字面量，可以用类似<em>YAML</em>的方法定义对象字面量</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">object1 = one: </span><span class="mi">1</span><span class="p">,</span> <span class="nv">two: </span><span class="mi">2</span>
</span><span class='line'><span class="nv">object2 =</span>
</span><span class='line'>  <span class="nv">one: </span><span class="mi">1</span>
</span><span class='line'>  <span class="nv">two: </span><span class="mi">2</span>
</span><span class='line'>  <span class="k">class</span><span class="o">:</span> <span class="s">&quot;numbers&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意保留字<code>class</code>，现在可以直接作为对象的key了</p>

<p>数组也可以分行</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">arr = </span><span class="p">[</span>
</span><span class='line'>  <span class="mi">1</span>
</span><span class='line'>  <span class="mi">2</span>
</span><span class='line'><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>也可以解构赋值(Destructuring)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">obj = </span><span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span><span class="s">&quot;bar&quot;</span><span class="p">}</span>
</span><span class='line'><span class="p">{</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">}</span> <span class="o">=</span> <span class="nx">obj</span>
</span><span class='line'><span class="nv">arr = </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arr</span>
</span></code></pre></td></tr></table></div></figure>


<h3>数组</h3>

<p>数组的操作引入了来自ruby的Range概念，并且可以将字符串完全作为数组操作</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">numbers = </span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">9</span><span class="p">]</span>
</span><span class='line'><span class="nx">numbers</span><span class="p">[</span><span class="mi">3</span><span class="p">..</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">]</span>
</span><span class='line'><span class="nv">my = </span><span class="s">&quot;my string&quot;</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">1</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>判断一个值是否在数组内，在js中可以用<code>Array.prototype.indexOf</code>，不过IE8及以下不支持，CoffeeScript提供了跨浏览器的<code>in</code>操作符解决</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">arr = </span><span class="p">[</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span><span class="p">]</span>
</span><span class='line'><span class="s">&quot;foo&quot;</span> <span class="k">in</span> <span class="nx">arr</span>
</span></code></pre></td></tr></table></div></figure>


<p>具体的实现上，是一个对<code>indexOf</code>的Shim</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>   <span class="kd">var</span> <span class="nx">arr</span><span class="p">,</span>
</span><span class='line'>     <span class="nx">__indexOf</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">indexOf</span> <span class="o">||</span> <span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>       <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>         <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="k">this</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">item</span><span class="p">)</span>
</span><span class='line'>           <span class="k">return</span> <span class="nx">i</span><span class="p">;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>       <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>     <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">arr</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;bar&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">__indexOf</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="s2">&quot;foo&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>for..in</code>语法可以用在数组上了，背后是用js的for循环实现的，这比数组的迭代器方法要效率高一些</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="s">&quot;Roger&quot;</span><span class="p">,</span> <span class="s">&quot;Roderick&quot;</span><span class="p">]</span>
</span><span class='line'>  <span class="nx">alert</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">i</span><span class="si">}</span><span class="s"> - Release </span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>也具有过滤器<code>when</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">prisoners = </span><span class="p">[</span><span class="s">&quot;Roger&quot;</span><span class="p">,</span> <span class="s">&quot;Roderick&quot;</span><span class="p">,</span> <span class="s">&quot;Brian&quot;</span><span class="p">]</span>
</span><span class='line'><span class="nx">release</span> <span class="nx">prisoner</span> <span class="k">for</span> <span class="nx">prisoner</span> <span class="k">in</span> <span class="nx">prisoners</span> <span class="k">when</span> <span class="nx">prisoner</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="s">&quot;R&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>看起来很像普通英语了，也可以用<code>()</code>收集遍历的结果</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">result = </span><span class="p">(</span><span class="nx">item</span> <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">array</span> <span class="k">when</span> <span class="nx">item</span><span class="p">.</span><span class="nx">name</span> <span class="o">is</span> <span class="s">&quot;test&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>遍历对象的属性可以用<code>of</code>,这是用js自己的<code>for..in</code>实现的</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">names = sam: </span><span class="nx">seaborn</span><span class="p">,</span> <span class="nv">donna: </span><span class="nx">moss</span>
</span><span class='line'><span class="nx">alert</span><span class="p">(</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">first</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">last</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="nx">first</span><span class="p">,</span> <span class="nx">last</span> <span class="k">of</span> <span class="nx">names</span>
</span></code></pre></td></tr></table></div></figure>


<h3>流程控制</h3>

<p>CoffeeScript使用来自ruby的省略语法，让控制流变得很紧凑，也引进了<code>unless</code>,<code>not</code>,<code>then</code>等语法糖式的关键字</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">result = </span><span class="k">if</span> <span class="o">not</span> <span class="kc">true</span> <span class="k">then</span> <span class="s">&quot;false&quot;</span>
</span><span class='line'><span class="nv">result = </span><span class="nx">unless</span> <span class="kc">true</span> <span class="k">then</span> <span class="s">&quot;false&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>CoffeeScript中非常好的一点，就是直接取消了js中的<code>==</code>判断，改成全部用<code>===</code>进行严格比较，js中的<code>==</code>会做大量诡异的类型转换，很多情况下是bug的来源</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="k">if</span> <span class="s">&quot;1&quot;</span> <span class="o">==</span> <span class="mi">1</span>
</span><span class='line'>  <span class="nx">alert</span><span class="p">(</span><span class="s">&quot;equal&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="nx">alert</span><span class="p">(</span><span class="s">&quot;not equal&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>在使用<code>if</code>来进行空值的判断时，js有时会让人困扰，因为&#8221;&#8220;和0都会被转换成false，Coffee提供了<code>?</code>操作符解决这个问题，她只有在变量为<code>null</code>或<code>undefined</code>时才为false</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="s">&quot;&quot;</span><span class="o">?</span> <span class="c1">#true</span>
</span><span class='line'><span class="kc">null</span><span class="o">?</span> <span class="c1">#false</span>
</span></code></pre></td></tr></table></div></figure>


<p>也可以用常见的类似ruby中<code>||=</code>的方法，判断赋值，此外还可以用<code>and</code>,<code>or</code>,<code>is</code>关键字代替<code>&amp;&amp;</code>,<code>||</code>,<code>==</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nx">hash</span> <span class="o">or=</span> <span class="p">{}</span>
</span><span class='line'><span class="nx">hash</span> <span class="o">?=</span> <span class="p">{}</span>
</span></code></pre></td></tr></table></div></figure>


<p>经常有当某个属性存在的时候，才会调用属性上的方法的情况，这时候也可以用<code>?</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nx">knight</span><span class="p">.</span><span class="nx">hasSword</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">poke</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>只有当<code>hasSword()</code>返回对象不为空时，才会调用<code>poke</code>方法，以下是编译的js代码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">_ref</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">((</span><span class="nx">_ref</span> <span class="o">=</span> <span class="nx">knight</span><span class="p">.</span><span class="nx">hasSword</span><span class="p">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">_ref</span><span class="p">.</span><span class="nx">poke</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>另一种情况是当<code>poke</code>方法存在时才调用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nx">knight</span><span class="p">.</span><span class="nx">hasSword</span><span class="p">().</span><span class="nx">poke</span><span class="o">?</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>对应的js代码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">_base</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="p">(</span><span class="nx">_base</span> <span class="o">=</span> <span class="nx">knight</span><span class="p">.</span><span class="nx">hasSword</span><span class="p">()).</span><span class="nx">poke</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">_base</span><span class="p">.</span><span class="nx">poke</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>switch case</code>语句也有了一些语法糖，并且会默认加上<code>break</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="k">switch</span> <span class="nx">day</span>
</span><span class='line'>  <span class="k">when</span> <span class="s">&quot;Sun&quot;</span> <span class="k">then</span> <span class="nx">go</span> <span class="nx">relax</span>
</span><span class='line'>  <span class="k">when</span> <span class="s">&quot;Sat&quot;</span> <span class="k">then</span> <span class="nx">go</span> <span class="nx">dancing</span>
</span><span class='line'>  <span class="k">else</span> <span class="nx">go</span> <span class="nx">work</span>
</span></code></pre></td></tr></table></div></figure>


<h3>函数</h3>

<p>CoffeeScript对JavaScript的函数做了很大的简化，举个例子，看一个求和函数</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">sum = </span><span class="nf">(nums...) -&gt;</span>
</span><span class='line'>  <span class="nx">nums</span><span class="p">.</span><span class="nx">reduce</span> <span class="nf">(x, y) -&gt;</span> <span class="nx">x</span><span class="o">+</span><span class="nx">y</span>
</span><span class='line'>
</span><span class='line'><span class="nx">sum</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span>
</span></code></pre></td></tr></table></div></figure>


<p>对应JavaScript</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">sum</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">__slice</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">sum</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">nums</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">nums</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">__slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="p">[];</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">nums</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span><span class="p">;</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nx">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>可以使用和ruby 1.9类似的<em>lambda函数</em>写法<code>-&gt;</code>来代替<code>function</code></li>
<li>参数列表放在<code>-&gt;</code>的前边，且可省略</li>
<li>取消了函数声明，只能将函数作为值定义</li>
<li>在CoffeeScript中，<strong>任何</strong>语句都是表达式(除了<code>break</code>和<code>continue</code>)，都有返回值，因此像ruby一样，不需要显式<code>return</code></li>
<li>js的函数参数有一个很讨厌的地方，就是参数对象<code>arguments</code>不是一个真正的数组，要使用数组方法，必须转换成数组<code>[].slice.call(arguments, 0)</code>这样，而在CoffeeScript中收束(加<code>...</code>)的参数是一个真正的数组</li>
</ul>


<p>CoffeeScript的函数可以有默认参数，如</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">times = </span><span class="nf">(a = 1, b = 2) -&gt;</span> <span class="nx">a</span> <span class="o">*</span> <span class="nx">b</span>
</span></code></pre></td></tr></table></div></figure>


<p>CoffeeScript的函数调用可以不用<code>()</code>语法包围参数，像ruby一样跟在函数名后面就可以，不过这也有时候会带来问题，特别是没有参数的调用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nx">alert</span>
</span></code></pre></td></tr></table></div></figure>


<p>对应的js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">alert</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>而不是<code>alert()</code>，这和ruby不同，需要注意</p>

<p>缩进的格式有时需要小心，比如用多个函数做参数的时候，需要这样写</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s">&quot;.toggle&quot;</span><span class="p">).</span><span class="nx">toggle</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="s">&quot;on&quot;</span>
</span><span class='line'><span class="p">,</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="s">&quot;off&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>对应js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.toggle&quot;</span><span class="p">).</span><span class="nx">toggle</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="s2">&quot;on&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="s2">&quot;off&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<hr />

<h2>模式</h2>

<p>使用CoffeeScript的一个重要理由，就是她用自己的语法实现了很多很常用的js编程模式，而且，通常是在社区内广泛被承认的最佳实践，如果不熟悉JavaScript的这些模式，可能会在调试代码上遇到一些麻烦，不过，基本上来说还是比较简单易懂的，下面我们会花一些时间研究一下CoffeeScript是用什么样的方法来封装这些通用编程模式的</p>

<h3>闭包</h3>

<p>在js中，普遍会使用闭包实现各种事件的handler或封装模块，以下是CoffeeScript对这一普遍模式的实现</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">closure = </span><span class="nx">do</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="nv">_private = </span><span class="s">&quot;foo&quot;</span>
</span><span class='line'>  <span class="o">-&gt;</span> <span class="nx">_private</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">closure</span><span class="p">())</span> <span class="c1">#=&gt; &quot;foo&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>do</code>关键词可以产生一个<em>Immediate Function</em>,下面是对应js代码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kd">var</span> <span class="nx">closure</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">closure</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">_private</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">_private</span> <span class="o">=</span> <span class="s2">&quot;foo&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">_private</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>  <span class="p">})();</span>
</span></code></pre></td></tr></table></div></figure>


<p>闭包中经常需要绑定<code>this</code>的值给闭包的私有变量，CoffeeScript使用特殊的<code>=&gt;</code>语法省去了这个麻烦</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="vi">@clickHandler = </span><span class="o">-&gt;</span> <span class="nx">alert</span> <span class="s">&quot;clicked&quot;</span>
</span><span class='line'><span class="nx">element</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="s">&quot;click&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@clickHandler</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用<code>=&gt;</code>生成函数，可以看到生成代码中会加上对<code>this</code>的绑定</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">this</span><span class="p">.</span><span class="nx">clickHandler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;clicked&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nx">element</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">clickHandler</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里CoffeeScript对于<code>this</code>有简单的别名<code>@</code></p>

<h3>扩展</h3>

<p>在js中，所有的对象都是开放的，有时候会扩展原有对象的行为(比如对数组的ECMA5 shim)，这也称为Monkey patching</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nb">String</span><span class="o">::</span><span class="nv">dasherize = </span><span class="o">-&gt;</span> <span class="nx">@replace</span> <span class="sr">/_/g</span><span class="p">,</span> <span class="s">&quot;-&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>::</code>代表原型的引用，js代码如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nb">String</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">dasherize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/_/g</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h3>类</h3>

<p>在js中是否要模拟传统编程语言的类，是个一直以来都有争议的话题，不同的项目，不同的团队，在类的使用上会有不同的看法，不过，一旦决定要使用类，那么至少需要一套良好的实现，CoffeeScript在语言内部实现了类的模拟，我们来看一看一个完整的例子</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="k">class</span> <span class="nx">Gadget</span>
</span><span class='line'>  <span class="vi">@CITY = </span><span class="s">&quot;beijing&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="vi">@create: </span><span class="nf">(name, price) -&gt;</span>
</span><span class='line'>    <span class="k">new</span> <span class="nx">Gadget</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">price</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">_price = </span><span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">constructor: </span><span class="nf">(@name, price) -&gt;</span>
</span><span class='line'>    <span class="nv">_price = </span><span class="nx">price</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">sell: </span><span class="o">=&gt;</span>
</span><span class='line'>    <span class="s">&quot;Buy </span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s"> with </span><span class="si">#{</span><span class="nx">_price</span><span class="si">}</span><span class="s"> in </span><span class="si">#{</span><span class="nx">Gadget</span><span class="p">.</span><span class="nx">CITY</span><span class="si">}</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">iphone = </span><span class="k">new</span> <span class="nx">Gadget</span><span class="p">(</span><span class="s">&quot;iphone&quot;</span><span class="p">,</span> <span class="mi">4999</span><span class="p">)</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">iphone</span><span class="p">.</span><span class="nx">name</span> <span class="c1">#=&gt; &quot;iphone&quot;</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">iphone</span><span class="p">.</span><span class="nx">sell</span><span class="p">()</span> <span class="c1">#=&gt; &quot;Buy iphone with 4999 in beijing&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">ipad = </span><span class="nx">Gadget</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s">&quot;ipad&quot;</span><span class="p">,</span> <span class="mi">3999</span><span class="p">)</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">ipad</span><span class="p">.</span><span class="nx">sell</span><span class="p">()</span> <span class="c1">#=&gt; &quot;Buy ipad with 3999 in beijing&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个Gadget类具有通常语言中类的功能:</p>

<ul>
<li><code>constructor</code>是构造函数，必须用这个名称，类似ruby中的initialize</li>
<li><code>name</code>是实例变量,可以通过<code>iphone.name</code>获取</li>
<li>构造函数中如果给实例变量赋值，直接将<code>@name</code>写在参数中即可，等价于在函数体中的<code>@name = name</code></li>
<li><code>_price</code>是私有变量,需要赋初始值</li>
<li><code>sell</code>是实例方法</li>
<li><code>create</code>是类方法，注意这里使用了<code>@create</code>，这和ruby有些像，在定义时的<code>this</code>指的是这个类本身</li>
<li><code>CITY</code>是类变量</li>
</ul>


<p>要注意的是，对于实例方法，要用<code>=&gt;</code>来绑定<code>this</code>，这样可以作为闭包传递，比如</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">iphone = </span><span class="k">new</span> <span class="nx">Gadget</span><span class="p">(</span><span class="s">&quot;iphone&quot;</span><span class="p">,</span> <span class="mi">4999</span><span class="p">)</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">sell&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">iphone</span><span class="p">.</span><span class="nx">sell</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果不用<code>=&gt;</code>，闭包被调用时就会丢失实例对象的值(<code>iphone</code>)</p>

<p>对于熟悉基于类的面向对象编程的人，CoffeeScript的类是一目了然的，下面来看看对应的js代码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kd">var</span> <span class="nx">Gadget</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">__bind</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">me</span><span class="p">){</span> <span class="k">return</span> <span class="kd">function</span><span class="p">(){</span> <span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">me</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">};</span> <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">Gadget</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">_price</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">Gadget</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;Gadget&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">Gadget</span><span class="p">.</span><span class="nx">CITY</span> <span class="o">=</span> <span class="s2">&quot;beijing&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">Gadget</span><span class="p">.</span><span class="nx">create</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">price</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nx">Gadget</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">price</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">_price</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">Gadget</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">price</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">sell</span> <span class="o">=</span> <span class="nx">__bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sell</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">_price</span> <span class="o">=</span> <span class="nx">price</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">Gadget</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sell</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="s2">&quot;Buy &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot; with &quot;</span> <span class="o">+</span> <span class="nx">_price</span> <span class="o">+</span> <span class="s2">&quot; in &quot;</span> <span class="o">+</span> <span class="nx">Gadget</span><span class="p">.</span><span class="nx">CITY</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">Gadget</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">})();</span>
</span></code></pre></td></tr></table></div></figure>


<p>以上的代码有很多值得注意的地方</p>

<ul>
<li>整体上来说，CoffeeScript的类模拟使用的是一个<em>构造函数闭包</em>，这是最常用的模拟类的模式，好处是可以完整地封装内部变量，且可以使用<code>new</code>来生成实例对象</li>
<li><code>_price</code>就是被封装在闭包内部的私有变量</li>
<li><code>sell</code>这样的实例方法是原型方法，并且在初始化时使用自定义的bind函数绑定实例(用<code>=&gt;</code>定义的情况)</li>
<li><code>create</code>和<code>CITY</code>这样的类成员使用构造函数的属性实现，重复一下，在CoffeeScript类定义中的<code>this</code>指的是整个闭包<code>Gadget</code></li>
<li><code>Gadget.name</code>是额外定义的类名属性</li>
</ul>


<h3>类的继承</h3>

<p>CoffeeScript中为方便地实现类的继承也定义了自己的语法，我们把上面的类简化，来看一下如何继承：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="k">class</span> <span class="nx">Gadget</span>
</span><span class='line'>  <span class="nv">constructor: </span><span class="nf">(@name) -&gt;</span>
</span><span class='line'>  <span class="nv">sell: </span><span class="o">=&gt;</span>
</span><span class='line'>    <span class="s">&quot;Buy </span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nx">IPhone</span> <span class="k">extends</span> <span class="nx">Gadget</span>
</span><span class='line'>  <span class="nv">constructor: </span><span class="o">-&gt;</span> <span class="k">super</span><span class="p">(</span><span class="s">&quot;iphone&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">nosell: </span><span class="o">=&gt;</span>
</span><span class='line'>    <span class="s">&quot;Don&#39;t </span><span class="si">#{</span><span class="nx">@sell</span><span class="p">()</span><span class="si">}</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">iphone = </span><span class="k">new</span> <span class="nx">IPhone</span>
</span><span class='line'><span class="nx">iphone</span><span class="p">.</span><span class="nx">nosell</span><span class="p">()</span> <span class="c1">#=&gt; Don&#39;t Buy iphone</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>使用<code>extends</code>关键字可以继承父类中的所有实例属性,比如<code>sell</code></li>
<li><code>super</code>方法可以调用父类的同名方法</li>
<li>如果不覆盖<code>constructor</code>，则她被子类默认调用</li>
</ul>


<p>来看一下对应的js代码，这有一些复杂，我们把和上边类定义中重复的地方去掉，只留下继承的实现部分</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kd">var</span> <span class="nx">Gadget</span><span class="p">,</span> <span class="nx">IPhone</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">({}.</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span>
</span><span class='line'>          <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="nx">child</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">IPhone</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">__extends</span><span class="p">(</span><span class="nx">IPhone</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">IPhone</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;IPhone&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">IPhone</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">nosell</span> <span class="o">=</span> <span class="nx">__bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">nosell</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">IPhone</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">&quot;iphone&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">IPhone</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">nosell</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="s2">&quot;Don&#39;t &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sell</span><span class="p">());</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">IPhone</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">})(</span><span class="nx">Gadget</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里重点有三个，</p>

<ul>
<li><code>__extends</code>函数使用了代理构造函数<code>ctor</code>来实现继承，这是非常普遍的js中对象继承的实践模式，进一步解释一下

<ul>
<li>使用代理构造函数的目的是为了避免子类被更改时父类受到影响</li>
<li>使用<code>ctor.prototype = parent.prototype</code>的意义是只继承定义在prototype上的公用属性</li>
</ul>
</li>
<li>父类的类成员被直接引用拷贝到子类，而不是原型继承</li>
<li><code>super</code>的实现方法是<code>parent.prototype.constructor.call(this)</code></li>
</ul>


<h3>混入(Mixin)</h3>

<p>在ruby语言中的Mixin，能够让你的类获得多个模块的方法，可以说是对多重继承一种很好的实现，虽然在CoffeeScript中并没有像ruby的<code>include</code>一样的内置功能，但很容易实现她</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="k">class</span> <span class="nx">Module</span>
</span><span class='line'>  <span class="vi">@extend: </span><span class="nf">(obj) -&gt;</span>
</span><span class='line'>    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">obj</span>
</span><span class='line'>      <span class="nx">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
</span><span class='line'>
</span><span class='line'>  <span class="vi">@include: </span><span class="nf">(obj) -&gt;</span>
</span><span class='line'>    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">obj</span>
</span><span class='line'>      <span class="nx">@</span><span class="o">::</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
</span><span class='line'>
</span><span class='line'><span class="nv">classProperties =</span>
</span><span class='line'>  <span class="nv">find: </span><span class="nf">(id) -&gt;</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&quot;find </span><span class="si">#{</span><span class="nx">id</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nv">instanceProperties =</span>
</span><span class='line'>  <span class="nv">save: </span><span class="o">-&gt;</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&quot;save&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nx">User</span> <span class="k">extends</span> <span class="nx">Module</span>
</span><span class='line'>  <span class="nx">@extend</span> <span class="nx">classProperties</span>
</span><span class='line'>  <span class="nx">@include</span> <span class="nx">instanceProperties</span>
</span><span class='line'>
</span><span class='line'><span class="nv">user = </span><span class="nx">User</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="nv">user = </span><span class="k">new</span> <span class="nx">User</span>
</span><span class='line'><span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>继承了Module的类才可以Mixin，当然，这里也可以用组合或者直接为js的构造函数做Monkey patching</li>
<li><code>classProperties</code>是类成员模块，使用<code>@extend</code>来Mixin，实现是简单的拷贝对象的属性</li>
<li><code>instanceProperties</code>是实例成员模块，使用<code>@include</code>来Mixin，实现是拷贝对象原型的属性</li>
<li>需要指出的是，这里的拷贝是引用拷贝，有可能外部会更改被Mixin的模块内部值，更好的方法是深层值拷贝(clone)，包括JQuery在内的很多类库都实现了这类扩展方法</li>
</ul>


<hr />

<h2>结语</h2>

<p>CoffeeScript提供了一门比JavaScript更强大，优雅，表现力丰富的语言，但她毕竟架构于JavaScript之上，而且是静态地编译成JavaScript代码，也就是说，她不能完全避免对JavaScript中一些不良部分的滥用，比如<code>eval</code>,<code>typeof</code>,<code>instanceof</code>等，所以，在任何情况下，建议始终开启<em>Strict Mode</em></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="s2">&quot;use strict&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>严格模式是一个ECMA5标准提出的js子集，禁用了很多js设计中不好的方面，在未来会逐渐成为js的语言标准，详细介绍在<a href="https://developer.mozilla.org/en/JavaScript/Strict_mode#Changes_in_strict_mode">这里</a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">lilu</span></span>

      








  


<time datetime="2012-08-06T12:52:00+08:00" pubdate data-updated="true">2012-08-06 12:52:00</time>
      


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    
    <ul class="pager">
      
      <li class="previous"><a class="basic-alignment left"
        href="/blog/2012/07/30/javascript/" title="Previous Post:
        JavaScript, The Hard Parts">&laquo; JavaScript, The Hard Parts</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
    </ul>
  </footer>
</article>

<aside class="sidebar-nav span3">
  
    <section class="well">
  <ul id="recent_posts" class="nav nav-list">
    <li class="nav-header">Recent Posts</li>
    
      <li class="post">
        <a href="/blog/2012/08/06/coffeescript/">Why coffee script is awesome</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/30/javascript/">JavaScript, The Hard Parts</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/18/sass/">Guide to SASS and Compass</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/13/markdown/">Markdown and Lightweight markup languages</a>
      </li>
    
  </ul>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo" class="page-footer"><hr>
<p>
  Copyright &copy; 2012 - lilu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
